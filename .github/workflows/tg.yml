name: ESET Key Generation

on:
  workflow_dispatch:
    inputs:
      mail:
        description: 'Mail provider'
        required: true
        type: choice
        options:
          - 1secmail
          - guerrillamail
          - developermail
          - mailticking
          - fakemail
          - inboxes
          - incognitomail
          - emailfake
        default: emailfake
      user_chat_id:
        description: 'Telegram chat ID'
        required: false

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        
      - name: Setup Python environment
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-venv
          python3 -m venv venv
          source venv/bin/activate
          pip install selenium requests colorama

      - name: Download ESET-KeyGen files directly
        run: |
          mkdir ESET-KeyGen
          cd ESET-KeyGen
          wget https://raw.githubusercontent.com/rzc0d3r/ESET-KeyGen/main/main.py
          wget https://raw.githubusercontent.com/rzc0d3r/ESET-KeyGen/main/requirements.txt
          wget https://raw.githubusercontent.com/rzc0d3r/ESET-KeyGen/main/README.md

      - name: Generate key
        id: generate
        run: |
          cd ESET-KeyGen
          source ../venv/bin/activate
          
          EMAIL_API="${{ inputs.mail || 'emailfake' }}"
          
          # Generate single key
          python3 main.py --auto-detect-browser --key --email-api $EMAIL_API \
            --skip-update-check --no-logo --disable-progress-bar --disable-logging
          
          # Extract the generated key
          KEY=$(grep -o 'ESET-[A-Z0-9]*-[A-Z0-9]*-[A-Z0-9]*-[A-Z0-9]*' ./*KEYS.txt | tail -n 1 || echo "No key generated")
          echo "key=$KEY" >> $GITHUB_OUTPUT

      - name: Send result to Telegram
        if: ${{ inputs.user_chat_id }}
        run: |
          if [[ "${{ steps.generate.outputs.key }}" != "No key generated" ]]; then
            curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=${{ inputs.user_chat_id }}" \
              -d "text=üîë –í–∞—à –∫–ª—é—á ESET:\n\n${{ steps.generate.outputs.key }}" \
              -d "parse_mode=Markdown"
          else
            curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=${{ inputs.user_chat_id }}" \
              -d "text=‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
          fi
