name: ESET Key Generation

on:
  workflow_dispatch:
    inputs:
      mail:
        description: 'Mail provider'
        required: true
        default: 'emailfake'
      user_chat_id:
        description: 'User chat ID for Telegram notifications'
        required: true

jobs:
  generate_key:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          sudo apt update
          sudo apt install -y python3-pip python3-venv
          git clone --depth 1 https://github.com/rzc0d3r/ESET-KeyGen.git
          cd ESET-KeyGen
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt

      - name: Generate single key
        id: generate
        run: |
          cd ESET-KeyGen
          source venv/bin/activate
          
          # Генерируем один ключ
          python3 main.py --auto-detect-browser --key --email-api ${{ inputs.mail }} \
            --skip-update-check --no-logo --disable-progress-bar --disable-logging
          
          # Извлекаем последний сгенерированный ключ
          KEY=$(tail -n 1 ./*KEYS.txt 2>/dev/null || echo "Не удалось сгенерировать ключ")
          echo "key=$KEY" >> $GITHUB_OUTPUT

      - name: Send key to user
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ inputs.user_chat_id }}" \
            -d "text=🔐 Ваш ключ ESET:\n\n${{ steps.generate.outputs.key }}" \
            -d "parse_mode=Markdown"
