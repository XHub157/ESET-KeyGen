name: ESET Key Generator

on:
  workflow_dispatch:
    inputs:
      mail:
        description: 'Mail provider'
        required: true
        type: choice
        options:
          - 1secmail
          - guerrillamail
          - developermail
          - mailticking
          - fakemail
          - inboxes
          - incognitomail
          - emailfake
        default: emailfake
      user_chat_id:
        description: 'Telegram chat ID'
        required: true

jobs:
  generate:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone ESET-KeyGen
        run: |
         git config --global url."https://api:${{ secrets.GGIT }}@github.com/".insteadOf "https://github.com/"
         git clone -b main https://github.com/XHub157/ESET-KeyGen

      - name: Setup Python
        shell: pwsh
        run: |
          cd ESET-KeyGen
          python -m venv venv
          .\venv\Scripts\pip install -r requirements.txt

      - name: Generate Key
        id: generate_key
        shell: pwsh
        run: |
          cd ESET-KeyGen
          .\venv\Scripts\python main.py --auto-detect-browser --key `
            --email-api "${{ inputs.mail }}" `
            --skip-update-check --no-logo `
            --disable-progress-bar --disable-logging
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
          if (-not (Test-Path .\ESET_KEYS.txt)) {
            Write-Error "–§–∞–π–ª —Å –∫–ª—é—á–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            exit 1
          }

      - name: Extract and Send Key
        shell: bash
        run: |
          cd ESET-KeyGen
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–ª—é—á –∏–∑ —Ñ–∞–π–ª–∞
          KEY=$(grep -E -o "[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}" ESET_KEYS.txt | tail -n 1)
          
          if [ -z "$KEY" ]; then
            MESSAGE="‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∫–ª—é—á –∏–∑ —Ñ–∞–π–ª–∞"
          else
            MESSAGE="üîë *–í–∞—à –∫–ª—é—á ESET*:\n\n\`$KEY\`\n\n_–î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç ESET_"
          fi

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ inputs.user_chat_id }}" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"
