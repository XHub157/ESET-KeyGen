name: ESET Key Generation

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:
    inputs:
      mail:
        description: 'Mail provider'
        required: true
        type: choice
        options:
          - 1secmail
          - guerrillamail
          - developermail
          - mailticking
          - fakemail
          - inboxes
          - incognitomail
          - emailfake
        default: emailfake
      user_chat_id:
        description: 'Telegram chat ID'
        required: true

jobs:
  generate_keys:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Generate keys
        id: generate
        run: |
          ACCOUNT=0
          KEY=1
          SMALL_BUSINESS_KEY=1
          VPN=0
          EMAIL_API="${{ inputs.mail || 'emailfake' }}"
          
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –∫–ª—é—á–∞–º–∏
          git clone --depth 1 https://github.com/rzc0d3r/ESET-KeyGen.git
          cd ESET-KeyGen
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
          sudo apt update
          sudo apt install -y python3-pip python3-venv
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–∏
          if [[ ${KEY} != 0 ]]; then
            python3 main.py --auto-detect-browser --key --email-api ${EMAIL_API} \
              --skip-update-check --no-logo --disable-progress-bar --disable-logging
            echo "standard_key=$(tail -n 1 ./*KEYS.txt)" >> $GITHUB_OUTPUT
          fi
          
          if [[ ${SMALL_BUSINESS_KEY} != 0 ]]; then
            python3 main.py --auto-detect-browser --small-business-key --email-api ${EMAIL_API} \
              --skip-update-check --no-logo --disable-progress-bar --disable-logging
            echo "business_key=$(tail -n 1 ./*KEYS.txt)" >> $GITHUB_OUTPUT
          fi
          
          cd ${{ github.workspace }}
          sudo rm -rf ESET-KeyGen

      - name: Send keys to Telegram
        run: |
          MESSAGE="üîë *–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏ ESET*:\n\n"
          
          if [[ "${{ steps.generate.outputs.standard_key }}" ]]; then
            MESSAGE+="*–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫–ª—é—á*:\n${{ steps.generate.outputs.standard_key }}\n\n"
          fi
          
          if [[ "${{ steps.generate.outputs.business_key }}" ]]; then
            MESSAGE+="*–ë–∏–∑–Ω–µ—Å-–∫–ª—é—á*:\n${{ steps.generate.outputs.business_key }}"
          fi
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ inputs.user_chat_id }}" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"

      - name: Update test time
        run: |
          sed -i 's/\(last_test-\)[0-9]\{2\}.[0-9]\{2\}.[0-9]\{4\}_[0-9]\{2\}:[0-9]\{2\}_UTC+3/\1'"$(date -u --date='3 hours' +"%d.%m.%Y_%H:%M_UTC+3")"'/' README.md
          git pull
          git commit -m "Update test time" -a

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.PAT }}
          branch: ${{ github.ref }}
