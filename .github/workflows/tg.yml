name: ESET Key Generator

on:
  workflow_dispatch:
    inputs:
      mail:
        description: 'Mail provider'
        required: true
        type: choice
        options:
          - 1secmail
          - guerrillamail
          - developermail
          - mailticking
          - fakemail
          - inboxes
          - incognitomail
          - emailfake
        default: emailfake
      user_chat_id:
        description: 'Telegram chat ID'
        required: true

jobs:
  generate:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone ESET-KeyGen
        shell: pwsh
        run: |
          git clone -b main https://github.com/XHub157/ESET-KeyGen
          cd ESET-KeyGen
          Get-ChildItem -Recurse | Where-Object { $_.Name -like "*KEYS.txt" } | Remove-Item -Force

      - name: Setup environment
        shell: pwsh
        run: |
          cd ESET-KeyGen
          python -m venv venv
          .\venv\Scripts\pip install -r requirements.txt

      - name: Generate keys
        id: generate
        shell: pwsh
        run: |
          cd ESET-KeyGen
          .\venv\Scripts\python main.py --auto-detect-browser --key `
            --email-api "${{ inputs.mail }}" `
            --skip-update-check --no-logo `
            --disable-progress-bar --disable-logging
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
          $keyFile = Get-ChildItem -Path . -Filter "*KEYS.txt" | Select-Object -First 1
          if (-not $keyFile) {
            Write-Error "–§–∞–π–ª —Å –∫–ª—é—á–∞–º–∏ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω"
            exit 1
          }
          $KEY = Get-Content -Path $keyFile.FullName -Tail 1
          echo "key=$KEY" >> $env:GITHUB_OUTPUT

      - name: Send key to Telegram
        shell: pwsh
        run: |
          $KEY = "${{ steps.generate.outputs.key }}"
          if ([string]::IsNullOrEmpty($KEY)) {
            $MESSAGE = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á"
          } else {
            $MESSAGE = "üîë –í–∞—à –∫–ª—é—á ESET:`n`n$KEY"
          }
          
          curl.exe -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" `
            -d "chat_id=${{ inputs.user_chat_id }}" `
            -d "text=$MESSAGE" `
            -d "parse_mode=Markdown"
