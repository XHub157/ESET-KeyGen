name: ESET Key Generation

on:
  workflow_dispatch:
    inputs:
      mail:
        description: 'Mail provider'
        required: true
        type: choice
        options:
          - 1secmail
          - guerrillamail
          - developermail
          - mailticking
          - fakemail
          - inboxes
          - incognitomail
          - emailfake
        default: emailfake
      user_chat_id:
        description: 'Telegram chat ID'
        required: false

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        
      - name: Setup environment
        run: |
          sudo apt update
          sudo apt install -y python3-pip python3-venv
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          
          # Download ESET-KeyGen directly
          wget https://github.com/rzc0d3r/ESET-KeyGen/archive/refs/heads/main.zip
          unzip main.zip
          mv ESET-KeyGen-main ESET-KeyGen
          cd ESET-KeyGen
          pip install -r requirements.txt

      - name: Generate keys
        id: generate
        run: |
          cd ESET-KeyGen
          source ../venv/bin/activate
          
          EMAIL_API="${{ inputs.mail || 'emailfake' }}"
          
          # Generate standard key
          python3 main.py --auto-detect-browser --key --email-api $EMAIL_API \
            --skip-update-check --no-logo --disable-progress-bar --disable-logging
          
          # Get the generated key
          KEY=$(tail -n 1 ./*KEYS.txt 2>/dev/null || echo "No key generated")
          echo "key=$KEY" >> $GITHUB_OUTPUT

      - name: Send key to Telegram
        if: ${{ inputs.user_chat_id }}
        run: |
          if [[ "${{ steps.generate.outputs.key }}" != "No key generated" ]]; then
            curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=${{ inputs.user_chat_id }}" \
              -d "text=üîë –í–∞—à –∫–ª—é—á ESET:\n\n${{ steps.generate.outputs.key }}" \
              -d "parse_mode=Markdown"
          else
            curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=${{ inputs.user_chat_id }}" \
              -d "text=‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á"
          fi
